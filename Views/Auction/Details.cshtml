@model Cartrade.Models.AuctionListing
@{
    ViewData["Title"] = "Auktionsdetaljer";
    var bidModel = (Cartrade.Models.ViewModels.PlaceBidViewModel)ViewData["BidModel"]!;
    var highestBid = Model.Bids.OrderByDescending(b => b.Amount).FirstOrDefault()?.Amount;
    var isOpen = !Model.IsClosed && Model.EndsAt > DateTimeOffset.UtcNow;
}

<div class="page-head">
    <div>
        <h1>@Model.Vehicle.RegistrationNumber</h1>
        <p>@Model.Vehicle.Make @Model.Vehicle.Model - Reserv @Model.ReservePrice.ToString("C0")</p>
    </div>
    <a asp-action="Index" class="btn btn-outline-brand">Tillbaka</a>
</div>

@if (TempData["Success"] is string success)
{
    <div class="alert alert-success">@success</div>
}
@if (TempData["Error"] is string error)
{
    <div class="alert alert-danger">@error</div>
}

<section class="details-grid">
    <article class="detail-card">
        <h2>Fordon</h2>
        <dl>
            <dt>Regnr</dt>
            <dd>@Model.Vehicle.RegistrationNumber</dd>
            <dt>Märke / Modell</dt>
            <dd>@Model.Vehicle.Make @Model.Vehicle.Model</dd>
            <dt>Årsmodell</dt>
            <dd>@Model.Vehicle.ModelYear</dd>
            <dt>Körsträcka</dt>
            <dd>@Model.Vehicle.OdometerKm km</dd>
            <dt>Partner</dt>
            <dd>@Model.Vehicle.PartnerName</dd>
        </dl>
    </article>

    <article class="detail-card">
        <h2>Auktion</h2>
        <dl>
            <dt>Status</dt>
            <dd>@(isOpen ? "Aktiv" : "Stängd")</dd>
            <dt>Publicerad</dt>
            <dd>@Model.PublishedAt.LocalDateTime.ToString("yyyy-MM-dd HH:mm")</dd>
            <dt>Avslutas</dt>
            <dd>@Model.EndsAt.LocalDateTime.ToString("yyyy-MM-dd HH:mm")</dd>
            <dt>Högsta bud</dt>
            <dd>@(highestBid.HasValue ? highestBid.Value.ToString("C0") : "Inget bud")</dd>
        </dl>
        @if ((User.IsInRole("Dealer") || User.IsInRole("Admin")) && isOpen)
        {
            <form asp-action="PlaceBid" method="post" class="mt-3">
                @Html.AntiForgeryToken()
                <input type="hidden" name="AuctionListingId" value="@Model.Id" />
                <label class="form-label" for="Amount">Nytt bud</label>
                <input type="number" step="500" min="1" name="Amount" id="Amount" class="form-control" value="@bidModel.Amount" />
                <button type="submit" class="btn btn-brand mt-2">Lägg bud</button>
            </form>
        }
    </article>
</section>

<section class="table-shell mt-4">
    <h2>Budhistorik</h2>
    <table class="table table-striped">
        <thead>
        <tr>
            <th>Tid</th>
            <th>Dealer</th>
            <th>Bud</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var bid in Model.Bids.OrderByDescending(b => b.CreatedAt))
        {
            <tr>
                <td>@bid.CreatedAt.LocalDateTime.ToString("yyyy-MM-dd HH:mm")</td>
                <td>@bid.DealerUserId</td>
                <td>@bid.Amount.ToString("C0")</td>
            </tr>
        }
        </tbody>
    </table>
</section>
